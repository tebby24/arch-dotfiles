#!/bin/zsh
# yadmpush - Commit and push updated dotfiles to GitHub

# Make tmp directory for error log
mkdir ~/tmp -p

# Ensure we're on the correct branch (change 'master' to your actual branch if needed)
BRANCH=$(yadm branch --show-current)
if [ -z "$BRANCH" ]; then
    yadm checkout master 2>&1 | tee ~/tmp/yadm_error.log
    BRANCH="master"
fi

# Stage only modified and deleted files, ignoring untracked files
yadm add -u

# Check if there are staged changes
if ! yadm diff --cached --exit-code > /dev/null; then
    # Commit with timestamp
    yadm commit -m "Auto-update: $(date)" 2>&1 | tee -a ~/tmp/yadm_error.log
    
    # Attempt to push and capture any errors
    if ! yadm push 2>&1 | tee -a ~/tmp/yadm_error.log; then
        notify-send "YADM Sync Failed" "Error: $(tail -n 5 /tmp/yadm_error.log)"
        exit 1
    fi

    # Success notification
    notify-send "YADM Sync" "Dotfiles successfully pushed to GitHub."
else
    notify-send "YADM Sync" "No changes to push."
fi

